var mt=Object.defineProperty;var vt=(i,t,e)=>t in i?mt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var u=(i,t,e)=>(vt(i,typeof t!="symbol"?t+"":t,e),e);import{_ as A,p as G,h as K,e as m,c as xt,a as rt,b as pt}from"./calendar-c06bd7ad.js";import{p as Pt}from"./lodash-6a49fb5a.js";var O={};Object.defineProperty(O,"__esModule",{value:!0});var bt=typeof window<"u"&&/Mac|iPod|iPhone|iPad/.test(window.navigator.platform),$={alt:"altKey",control:"ctrlKey",meta:"metaKey",shift:"shiftKey"},ht={add:"+",break:"pause",cmd:"meta",command:"meta",ctl:"control",ctrl:"control",del:"delete",down:"arrowdown",esc:"escape",ins:"insert",left:"arrowleft",mod:bt?"meta":"control",opt:"alt",option:"alt",return:"enter",right:"arrowright",space:" ",spacebar:" ",up:"arrowup",win:"meta",windows:"meta"},Z={backspace:8,tab:9,enter:13,shift:16,control:17,alt:18,pause:19,capslock:20,escape:27," ":32,pageup:33,pagedown:34,end:35,home:36,arrowleft:37,arrowup:38,arrowright:39,arrowdown:40,insert:45,delete:46,meta:91,numlock:144,scrolllock:145,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222};for(var H=1;H<20;H++)Z["f"+H]=111+H;function j(i,t,e){t&&!("byKey"in t)&&(e=t,t=null),Array.isArray(i)||(i=[i]);var n=i.map(function(c){return ct(c,t)}),s=function(o){return n.some(function(h){return lt(h,o)})},a=e==null?s:s(e);return a}function wt(i,t){return j(i,t)}function Et(i,t){return j(i,{byKey:!0},t)}function ct(i,t){var e=t&&t.byKey,n={};i=i.replace("++","+add");var s=i.split("+"),a=s.length;for(var c in $)n[$[c]]=!1;var o=!0,h=!1,r=void 0;try{for(var g=s[Symbol.iterator](),d;!(o=(d=g.next()).done);o=!0){var f=d.value,P=f.endsWith("?")&&f.length>1;P&&(f=f.slice(0,-1));var x=z(f),w=$[x];if(f.length>1&&!w&&!ht[f]&&!Z[x])throw new TypeError('Unknown modifier: "'+f+'"');(a===1||!w)&&(e?n.key=x:n.which=dt(f)),w&&(n[w]=P?null:!0)}}catch(L){h=!0,r=L}finally{try{!o&&g.return&&g.return()}finally{if(h)throw r}}return n}function lt(i,t){for(var e in i){var n=i[e],s=void 0;if(n!=null&&(e==="key"&&t.key!=null?s=t.key.toLowerCase():e==="which"?s=n===91&&t.which===93?91:t.which:s=t[e],!(s==null&&n===!1)&&s!==n))return!1}return!0}function dt(i){i=z(i);var t=Z[i]||i.toUpperCase().charCodeAt(0);return t}function z(i){return i=i.toLowerCase(),i=ht[i]||i,i}var Y=O.default=j;O.isHotkey=j;O.isCodeHotkey=wt;O.isKeyHotkey=Et;O.parseHotkey=ct;O.compareHotkey=lt;O.toKeyCode=dt;O.toKeyName=z;const S=i=>{let t=1/0,e=1/0,n=0,s=0;return i.forEach(a=>{a.x<t&&(t=a.x),a.y<e&&(e=a.y),a.x>n&&(n=a.x),a.y>s&&(s=a.y)}),{left:t,top:e,right:n,bottom:s,width:n-t,height:s-e}},D=()=>window.devicePixelRatio,M=i=>D()*i;var yt=(i=>(i[i.RECTANGLE=0]="RECTANGLE",i[i.POLYGON=1]="POLYGON",i[i.ELLIPSE=2]="ELLIPSE",i))(yt||{});const Lt=async(i,t,e)=>{const n=document.createElement("canvas"),s=n.getContext("2d");if(!s)return;n.width=i.width,n.height=i.height,s.putImageData(i,0,0);const a=await new Promise(c=>{n.toBlob(o=>{if(!o){c(void 0);return}const h=URL.createObjectURL(o);c(h)})});if(a&&t){const c=await ut(a,t,e);return URL.revokeObjectURL(a),c}return a},q=async(i,t,e)=>{const n=document.createElement("canvas"),s=n.getContext("2d");if(!s)return;n.width=i.width,n.height=i.height,s.putImageData(i,0,0);const a=n.toDataURL();return t?await ut(a,t,e):a},ut=async(i,t,e=1)=>{const n=a=>{const c=new Image,o=()=>{const h=document.createElement("canvas");h.width=c.width,h.height=c.height;const r=h.getContext("2d");if(!r){a(void 0);return}const{left:g,top:d}=S(t),f=D();if(t=t.map(x=>({x:(x.x-g)*f,y:(x.y-d)*f})),r.beginPath(),e===2){const[x,w]=t,{x:L,y:C}=x,{x:T,y:l}=w,p=Math.abs(T-L),k=Math.abs(l-C),R=Math.min(T,L)+p/2,b=Math.min(l,C)+k/2;r.ellipse(R,b,p/2,k/2,0,0,2*Math.PI)}else t.forEach((x,w)=>{w===0?r.moveTo(x.x,x.y):r.lineTo(x.x,x.y)});r.closePath(),r.clip(),r.drawImage(c,0,0);const P=h.toDataURL();a(P)};c.onload=o,c.src=i};return await new Promise(n)},J=300,F=150,nt=[{x:50,y:80},{x:50,y:200},{x:250,y:200},{x:220,y:100}],Ct=()=>{const i=A(null),t=A(null),[e,n]=G();return K(()=>{kt(i.current)},[]),K(()=>()=>{var o;(o=e==null?void 0:e.url)!=null&&o.startsWith("blob:")&&URL.revokeObjectURL(e.url)},[e]),m("section",{className:"mt-6 pt-2",children:[m("h1",{className:"mb-4 border-b text-2xl",children:"裁剪"}),m("div",{className:"flex",children:[m("div",{className:"mr-2",children:[m("button",{onClick:async()=>{if(!i.current)return;const o=i.current.getContext("2d");if(!o)return;const h=o.getImageData(0,0,M(J),M(F)),r=await q(h);r&&n({width:J,height:F,url:r})},className:"border",children:"裁剪房顶(data url)"}),m("button",{onClick:async()=>{const o=document.createElement("canvas"),h=o.getContext("2d");if(!h)return;const r=t.current;if(!r)return;o.width=r.naturalWidth,o.height=r.naturalHeight,h.drawImage(r,0,0);const g=h.getImageData(o.width/4,o.height/4,o.width/2,o.height/2),d=await Lt(g);d&&n({width:J,height:F,url:d})},className:"ml-6 border",children:"裁剪图片(blob url)"}),m("button",{onClick:async()=>{const o=i.current;if(!o)return;const h=o.getContext("2d");if(!h)return;const{left:r,top:g,width:d,height:f}=S(nt),P=h.getImageData(M(r),M(g),M(d),M(f)),x=await q(P,nt);x&&n({width:d,height:f,url:x})},className:"ml-6 border",children:"裁剪不规则图片(blob url)"}),e&&m("img",{src:e.url,alt:"裁剪图片",width:e.width,height:e.height,className:"mt-2 border"})]}),m("canvas",{ref:i,style:{width:300,height:350},className:"border"}),m("img",{ref:t,src:"/images/earth.jpeg",width:500,className:"ml-2"})]})]})},kt=i=>{if(!i)return;const t=i.getContext("2d");if(!t)return;i.width=Math.floor(M(i.clientWidth)),i.height=Math.floor(M(i.clientHeight));const e=D();t.scale(e,e),t.font='20px -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif, PingFang SC',t.lineWidth=10,t.strokeRect(75,140,150,110),t.fillRect(130,190,40,60),t.beginPath(),t.moveTo(50,140),t.lineTo(150,60),t.lineTo(250,140),t.closePath(),t.stroke(),t.fillText("this is a house",80,300)},Rt=()=>{const i=A(null),t=A(null);return K(()=>{it(i.current,50),it(t.current,50,!0)},[]),m("section",{className:"mt-6 pt-2",children:[m("h1",{className:"mb-4 border-b text-2xl",children:"棋盘"}),m("div",{className:"flex",children:[m("canvas",{ref:i,style:{width:301,height:351}}),m("canvas",{ref:t,style:{width:301,height:351},className:"ml-2"})]})]})},it=(i,t,e=!1)=>{if(!i)return;const n=i.getContext("2d");if(!n)return;i.width=Math.floor(M(i.clientWidth)),i.height=Math.floor(M(i.clientHeight));const s=D();n.scale(s,s),n.lineWidth=1;const a=Math.ceil(i.clientHeight/t),c=Math.floor(i.width/t);n.strokeStyle="#ccc";for(let o=0;o<a;o++)if(n.beginPath(),n.moveTo(0,o*t+.5),n.lineTo(i.clientWidth,o*t+.5),n.stroke(),e)for(let h=0;h<c;h++)n.fillStyle=Mt(),n.fillRect(o*t+1,h*t+1,t-1,t-1);for(let o=0;o<c;o++)n.beginPath(),n.moveTo(o*t+.5,0),n.lineTo(o*t+.5,i.clientHeight),n.stroke()},Mt=()=>{const i=Math.floor(Math.random()*150);return`rgba(${100+i}, ${100+i}, ${100+i}, 0.4)`};var ft={exports:{}};(function(i,t){(function(e,n){i.exports=n()})(xt,function(){return function e(n,s,a){var c=window,o="application/octet-stream",h=a||o,r=n,g=!s&&!a&&r,d=document.createElement("a"),f=function(b){return String(b)},P=c.Blob||c.MozBlob||c.WebKitBlob||f,x=s||"download",w,L;if(P=P.call?P.bind(c):Blob,String(this)==="true"&&(r=[r,h],h=r[0],r=r[1]),g&&g.length<2048&&(x=g.split("/").pop().split("?")[0],d.href=g,d.href.indexOf(g)!==-1)){var C=new XMLHttpRequest;return C.open("GET",g,!0),C.responseType="blob",C.onload=function(b){e(b.target.response,x,o)},setTimeout(function(){C.send()},0),C}if(/^data:([\w+-]+\/[\w+.-]+)?[,;]/.test(r))if(r.length>1024*1024*1.999&&P!==f)r=k(r),h=r.type||o;else return navigator.msSaveBlob?navigator.msSaveBlob(k(r),x):R(r);else if(/([\x80-\xff])/.test(r)){var T=0,l=new Uint8Array(r.length),p=l.length;for(T;T<p;++T)l[T]=r.charCodeAt(T);r=new P([l],{type:h})}w=r instanceof P?r:new P([r],{type:h});function k(b){var W=b.split(/[:;,]/),N=W[1],X=W[2]=="base64"?atob:decodeURIComponent,B=X(W.pop()),tt=B.length,U=0,et=new Uint8Array(tt);for(U;U<tt;++U)et[U]=B.charCodeAt(U);return new P([et],{type:N})}function R(b,W){if("download"in d)return d.href=b,d.setAttribute("download",x),d.className="download-js-link",d.innerHTML="downloading...",d.style.display="none",document.body.appendChild(d),setTimeout(function(){d.click(),document.body.removeChild(d),W===!0&&setTimeout(function(){c.URL.revokeObjectURL(d.href)},250)},66),!0;if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent))return/^data:/.test(b)&&(b="data:"+b.replace(/^data:([\w\/\-\+]+)/,o)),window.open(b)||confirm(`Displaying New Document

Use Save As... to download, then click back to return to this page.`)&&(location.href=b),!0;var N=document.createElement("iframe");document.body.appendChild(N),!W&&/^data:/.test(b)&&(b="data:"+b.replace(/^data:([\w\/\-\+]+)/,o)),N.src=b,setTimeout(function(){document.body.removeChild(N)},333)}if(navigator.msSaveBlob)return navigator.msSaveBlob(w,x);if(c.URL)R(c.URL.createObjectURL(w),!0);else{if(typeof w=="string"||w.constructor===f)try{return R("data:"+h+";base64,"+c.btoa(w))}catch{return R("data:"+h+","+encodeURIComponent(w))}L=new FileReader,L.onload=function(b){R(this.result)},L.readAsDataURL(w)}return!0}})})(ft);const gt=ft.exports;function Tt(){return typeof __SENTRY_BROWSER_BUNDLE__<"u"&&!!__SENTRY_BROWSER_BUNDLE__}function Nt(){return!Tt()&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]"}var Ot={};function Wt(){return Nt()?global:typeof window<"u"?window:typeof self<"u"?self:Ot}function Dt(){var i=Wt(),t=i.crypto||i.msCrypto;if(t!==void 0&&t.getRandomValues){var e=new Uint16Array(8);t.getRandomValues(e),e[3]=e[3]&4095|16384,e[4]=e[4]&16383|32768;var n=function(s){for(var a=s.toString(16);a.length<4;)a="0"+a;return a};return n(e[0])+n(e[1])+n(e[2])+n(e[3])+n(e[4])+n(e[5])+n(e[6])+n(e[7])}return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(s){var a=Math.random()*16|0,c=s==="x"?a:a&3|8;return c.toString(16)})}var v=(i=>(i.POLYGON="polygon",i.RECTANGLE="rectangle",i.CIRCLE="circle",i.LINE="line",i.ARROW="arrow",i.ERASER="eraser",i))(v||{}),E=(i=>(i.GREEN="green",i.BLUE="blue",i.YELLOW="yellow",i.RED="red",i))(E||{}),y=(i=>(i.ADD="add",i.UPDATE="update",i.DELETE="delete",i))(y||{});const It=(i,t)=>{const e=i.getContext("2d");e&&(e.beginPath(),e.arc(t.x,t.y,5,0,2*Math.PI),e.fill())},_=(i,t,e,n)=>{const s=i.getContext("2d");if(!s)return;const{x:a,y:c}=t,{x:o,y:h}=e,r=Math.abs(o-a),g=Math.abs(h-c),d=Math.min(o,a)+r/2,f=Math.min(h,c)+g/2;s.save(),n!=null&&n.strokeStyle&&(s.strokeStyle=n.strokeStyle),n!=null&&n.lineWidth&&(s.lineWidth=n.lineWidth),s.beginPath(),s.ellipse(d,f,r/2,g/2,0,0,2*Math.PI),n!=null&&n.isFill?s.fill():s.stroke(),s.restore()},st=(i,t,e,n)=>{const s=i.getContext("2d");if(!s)return;const{x:a,y:c}=t,{x:o,y:h}=e,r=Math.abs(o-a),g=Math.abs(h-c),d=Math.min(o,a),f=Math.min(h,c);s.save(),n!=null&&n.strokeStyle&&(s.strokeStyle=n.strokeStyle),n!=null&&n.lineWidth&&(s.lineWidth=n.lineWidth),s.beginPath(),s.strokeRect(d,f,r,g),s.restore()},ot=(i,t,e,n)=>{const s=i.getContext("2d");if(!s)return;const{x:a,y:c}=t,{x:o,y:h}=e,r=o-a,g=h-c,d=Math.atan2(g,r);s.save(),s.lineJoin="round",n!=null&&n.lineWidth&&(s.lineWidth=n==null?void 0:n.lineWidth),n!=null&&n.strokeStyle&&(s.strokeStyle=n==null?void 0:n.strokeStyle),s.beginPath(),s.moveTo(a,c),s.lineTo(o,h);const f=s.lineWidth*5;s.lineTo(o-f*Math.cos(d-Math.PI/6),h-f*Math.sin(d-Math.PI/6)),s.moveTo(o,h),s.lineTo(o-f*Math.cos(d+Math.PI/6),h-f*Math.sin(d+Math.PI/6)),s.stroke(),s.restore()},I=(i,t,e)=>{i.save(),e&&(e!=null&&e.lineWidth&&(i.lineWidth=e==null?void 0:e.lineWidth),e!=null&&e.strokeStyle&&(i.strokeStyle=e==null?void 0:e.strokeStyle),e!=null&&e.fillStyle&&(i.fillStyle=e==null?void 0:e.fillStyle),e!=null&&e.lineCap&&(i.lineCap=e==null?void 0:e.lineCap),e!=null&&e.lineJoin&&(i.lineJoin=e==null?void 0:e.lineJoin));const n=s=>{i.beginPath(),i.arc(s.x,s.y,5,0,2*Math.PI),i.fill()};(e==null?void 0:e.joinShape)==="round"&&(t.forEach(n),i.lineJoin="round"),i.beginPath(),t.forEach((s,a)=>{a===0?i.moveTo(s.x,s.y):i.lineTo(s.x,s.y)}),e!=null&&e.closePath&&i.closePath(),e!=null&&e.isFill?i.fill():i.stroke(),i.restore()},Q=(i,t)=>{const e=i.getContext("2d");e&&(e.save(),e.beginPath(),e.globalCompositeOperation="destination-out",e.arc(t.x,t.y,5,0,2*Math.PI),e.clip(),e.clearRect(0,0,i.width,i.height),e.restore())},at=(i,t,e)=>{const n=i.getContext("2d");if(!n)return;const{x:s,y:a}=t,{x:c,y:o}=e,h=5*Math.sin(Math.atan((o-a)/(c-s))),r=5*Math.cos(Math.atan((o-a)/(c-s))),g=s+h,d=a-r,f=s-h,P=a+r,x=c+h,w=o-r,L=c-h,C=o+r;Q(i,e),n.save(),n.beginPath(),n.globalCompositeOperation="destination-out",n.moveTo(g,d),n.lineTo(x,w),n.lineTo(L,C),n.lineTo(f,P),n.closePath(),n.clip(),n.clearRect(0,0,i.width,i.height),n.restore()},At=(i,t,e)=>{const n=i.getContext("2d");if(!n)return;const s=t[0],a=t[1],{x:c,y:o}=s,{x:h,y:r}=a,g=Math.abs(h-c),d=Math.abs(r-o),f=Math.min(h,c)+g/2,P=Math.min(r,o)+d/2;n.lineWidth=Math.max(8,(e==null?void 0:e.lineWidth)??0),n.beginPath(),n.ellipse(f,P,g/2,d/2,0,0,2*Math.PI),n.closePath()},Bt=(i,t,e)=>{const n=i.getContext("2d");if(!n)return;const s=t[0],a=t[1],{x:c,y:o}=s,{x:h,y:r}=a,g=Math.abs(h-c),d=Math.abs(r-o),f=Math.min(h,c),P=Math.min(r,o);n.lineWidth=Math.max(8,(e==null?void 0:e.lineWidth)??0),n.beginPath(),n.rect(f,P,g,d)},Ut=(i,t,e)=>{const n=i.getContext("2d");n&&(n.lineWidth=Math.max(8,(e==null?void 0:e.lineWidth)??0),n.beginPath(),t.forEach((s,a)=>{a===0?n.moveTo(s.x,s.y):n.lineTo(s.x,s.y)}),e.closePath&&n.closePath())};class Gt{constructor(t){u(this,"delay",1e3);u(this,"maxStack",100);u(this,"userOnly",!1);u(this,"lastRecorded",0);u(this,"redoStack",[]);u(this,"undoStack",[]);this.canvasBoard=t}record(t,e){const n=this.inverse(t,e);n&&this.undoStack.push(n)}inverse(t,e){switch(t.type){case y.ADD:return{type:y.DELETE,uuid:t.uuid};case y.DELETE:return{type:y.ADD,uuid:t.uuid};case y.UPDATE:{if(!t.patch)return;const n=Pt(e,Object.keys(t.patch));return{type:y.UPDATE,uuid:t.uuid,patch:n}}}}redo(){if(this.redoStack.length===0)return;const t=this.redoStack.pop();if(!t)return;const e=this.inverse(t,this.canvasBoard.allShape[t==null?void 0:t.uuid]);e&&(this.undoStack.push(e),this.undoStack.length>this.maxStack&&this.undoStack.shift()),this.canvasBoard.applyOP(t)}undo(){if(this.undoStack.length===0)return;const t=this.undoStack.pop();if(!t)return;const e=this.inverse(t,this.canvasBoard.allShape[(t==null?void 0:t.uuid)??""]);e&&(this.redoStack.push(e),this.redoStack.length>this.maxStack&&this.redoStack.shift()),this.canvasBoard.applyOP(t)}clear(){this.redoStack=[],this.undoStack=[]}}class Ht{constructor(t,e,n=2,s="#000"){u(this,"pathStack",{redo:[],undo:[]});u(this,"allShape",{});u(this,"drawingPath",[]);u(this,"hoverShape");u(this,"activeShape");u(this,"isMoving",!1);u(this,"isPolygonDrawing",!1);u(this,"ctx");u(this,"onPenPointChange");u(this,"history");u(this,"oldShape",[]);u(this,"memoCanvas",document.createElement("canvas"));u(this,"initContext",()=>{const t=D();if(this.canvas.width=Math.floor(this.canvas.clientWidth*t),this.canvas.height=Math.floor(this.canvas.clientHeight*t),this.ctx=this.canvas.getContext("2d"),!this.ctx)return;this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.lineWidth,this.ctx.scale(t,t),this.setBackground();const e=s=>{s.forEach(a=>{a.target===this.canvas&&this.updateCtx()})};new ResizeObserver(e).observe(this.canvas)});u(this,"updateCtx",()=>{const t=D();this.canvas.width=Math.floor(this.canvas.clientWidth*t),this.canvas.height=Math.floor(this.canvas.clientHeight*t),this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.lineWidth,this.ctx.scale(t,t),this.refresh())});u(this,"bindEvent",()=>{const t=n=>{if(this.hoverShape){this.moveShape(n);return}if(this.drawType===v.POLYGON){this.drawPolygon(n);return}if(this.drawType===v.RECTANGLE){this.drawRectangle(n);return}if(this.drawType===v.CIRCLE){this.drawCircle(n);return}if(this.drawType===v.ARROW){this.dragArrow(n);return}(this.drawType===v.LINE||this.drawType===v.ERASER)&&this.drawLineAndEraser(n)},e=n=>{var s,a;Y("esc")(n)?this.drawType===v.POLYGON&&this.closePolygon():Y("Backspace")(n)&&this.activeShape&&(this.allShape[(s=this.activeShape)==null?void 0:s.uuid].live=!1,(a=this.history)==null||a.record({type:y.DELETE,uuid:this.activeShape.uuid}),this.refresh())};window.addEventListener("keydown",e),this.canvas.addEventListener("mousedown",t),this.canvas.addEventListener("mousemove",this.detectShape)});u(this,"refresh",()=>{this.ctx&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),Object.values(this.allShape).forEach(({live:t,type:e,strokeStyle:n,path:s,lineWidth:a})=>{this.ctx&&t&&(e===v.POLYGON?I(this.ctx,s,{lineWidth:a,strokeStyle:n,closePath:!0}):e===v.RECTANGLE?st(this.canvas,s[0],s[1],{lineWidth:a,strokeStyle:n}):e===v.LINE?I(this.ctx,s,{lineWidth:a,strokeStyle:n,lineCap:"round",lineJoin:"round"}):e===v.CIRCLE?_(this.canvas,s[0],s[1],{lineWidth:a,strokeStyle:n}):e===v.ERASER?s.forEach((c,o)=>{o!==s.length-1&&(o===0?Q(this.canvas,c):at(this.canvas,c,s[o+1]))}):e===v.ARROW&&ot(this.canvas,s[0],s[1],{lineWidth:a,strokeStyle:n}))}))});u(this,"moveShape",t=>{this.isMoving=!0;const e=this.getPoint(t),n=a=>{var g;if(!this.hoverShape)return;const c=this.getPoint(a),o=c.x-e.x,h=c.y-e.y,r=this.hoverShape.path.map(d=>({x:d.x+o,y:d.y+h}));this.allShape[(g=this.hoverShape)==null?void 0:g.uuid].path=r,this.refresh()},s=()=>{var a,c;if(document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s),this.hoverShape){if(!this.ctx)return;const o=this.allShape[(a=this.hoverShape)==null?void 0:a.uuid];if(!o)return;const{path:h}=o;(c=this.history)==null||c.record({type:y.UPDATE,uuid:this.hoverShape.uuid,patch:{path:h}},this.hoverShape);const r=S(h);this.ctx.save(),this.ctx.lineWidth=2,this.ctx.strokeStyle="rgba(0,255,0,0.5)",this.ctx.strokeRect(r.left,r.top,r.width,r.height),this.ctx.restore(),this.activeShape=o}this.isMoving=!1,this.hoverShape=void 0};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)});u(this,"getPoint",t=>{const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.x,y:t.clientY-e.y}});u(this,"drawLineAndEraser",t=>{let e=this.getPoint(t);this.drawingPath.push(e),this.drawType===v.ERASER&&Q(this.canvas,e);const n=a=>{if(!this.ctx)return;const c=this.getPoint(a);this.drawingPath.push(c),this.drawType===v.LINE?I(this.ctx,[e,c],{lineCap:"round",lineJoin:"round"}):at(this.canvas,e,c),e=c},s=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s),this.ctx&&(this.addShape(),this.drawingPath=[])};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)});u(this,"drawPolygon",t=>{var n;if(!this.ctx)return;if(!this.isPolygonDrawing){this.isPolygonDrawing=!0;const s=c=>{if(!this.isPolygonDrawing){document.removeEventListener("keydown",a),document.removeEventListener("mousemove",s);return}if(!this.ctx)return;this.drawingPath=this.drawingPath.filter(r=>!r.isTemp);const o=this.getPoint(c),h=this.drawingPath[0];this.drawingPath.length>2&&Math.abs(h.x-o.x)<8&&Math.abs(h.y-o.y)<8?this.drawingPath.push({...h,isTemp:!0}):this.drawingPath.push({...o,isTemp:!0}),this.refresh(),this.drawingPath.length!==1&&I(this.ctx,this.drawingPath,{lineCap:"round",joinShape:"round"})},a=c=>{if(this.isPolygonDrawing){if(Y("mod+z")(c)){const o=this.pathStack.undo.pop();if(o){this.pathStack.redo.push([...this.drawingPath.filter(r=>!r.isTemp)]);const h=this.drawingPath.find(r=>r.isTemp);if(this.drawingPath=h?o.concat(h):o,this.ctx){if(this.refresh(),this.drawingPath.length===1)return;I(this.ctx,this.drawingPath,{lineCap:"round",joinShape:"round"})}}}if(Y("mod+shift+z")(c)){const o=this.pathStack.redo.pop();if(o){this.pathStack.undo.push([...this.drawingPath.filter(r=>!r.isTemp)]);const h=this.drawingPath.find(r=>r.isTemp);if(this.drawingPath=h?o.concat(h):o,this.ctx){if(this.refresh(),this.drawingPath.length===1)return;I(this.ctx,this.drawingPath,{lineCap:"round",joinShape:"round"})}}}}};document.addEventListener("keydown",a),document.addEventListener("mousemove",s)}if(this.drawingPath.length>3){const s=this.drawingPath[0],a=this.drawingPath[this.drawingPath.length-1];if(s.x===a.x&&s.y===a.y){this.closePolygon();return}}const e=this.getPoint(t);It(this.canvas,e),this.pathStack.undo.push([...this.drawingPath.filter(s=>!s.isTemp)]),this.drawingPath.push(e),(n=this.onPenPointChange)==null||n.call(this,this.drawingPath)});u(this,"drawCircle",t=>{let e=!1;this.drawingPath.push(this.getPoint(t));const n=h=>{if(!this.ctx)return;this.drawingPath.length>1&&this.drawingPath.pop();const r=this.getPoint(h);this.drawingPath.push(r),this.refresh();const g=e?s(this.drawingPath[0],r):r;_(this.canvas,this.drawingPath[0],g)},s=(h,r)=>{const g=r.x-h.x,d=r.y-h.y,f=Math.max(Math.abs(g),Math.abs(d));return{x:g>0?h.x+f:h.x-f,y:d>0?h.y+f:h.y-f}},a=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),document.removeEventListener("keydown",c),document.removeEventListener("keyup",o),this.ctx&&(this.drawingPath.length>1&&(e&&(this.drawingPath[1]=s(this.drawingPath[0],this.drawingPath[1])),this.addShape()),this.drawingPath=[])},c=h=>{if(h.shiftKey){e=!0,this.refresh();const r=s(this.drawingPath[0],this.drawingPath[1]);_(this.canvas,this.drawingPath[0],r)}},o=()=>{e=!1,this.refresh(),_(this.canvas,this.drawingPath[0],this.drawingPath[1])};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a),document.addEventListener("keydown",c),document.addEventListener("keyup",o)});u(this,"drawRectangle",t=>{this.drawingPath.push(this.getPoint(t));const e=s=>{this.ctx&&(this.drawingPath.length>1&&this.drawingPath.pop(),this.drawingPath.push(this.getPoint(s)),this.refresh(),st(this.canvas,this.drawingPath[0],this.drawingPath[1]))},n=()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",n),this.ctx&&(this.drawingPath.length>1&&this.addShape(),this.drawingPath=[])};document.addEventListener("mousemove",e),document.addEventListener("mouseup",n)});u(this,"dragArrow",t=>{if(!this.ctx)return;this.drawingPath.push(this.getPoint(t));const e=s=>{this.ctx&&(this.drawingPath.length>1&&this.drawingPath.pop(),this.drawingPath.push(this.getPoint(s)),this.refresh(),console.log(this.ctx.lineWidth),ot(this.canvas,this.drawingPath[0],this.drawingPath[1]))},n=()=>{this.ctx&&(this.drawingPath.length>1&&this.addShape(),this.drawingPath=[],document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",n))};document.addEventListener("mousemove",e),document.addEventListener("mouseup",n)});u(this,"addShape",()=>{var e;if(!this.ctx)return;const t={lineWidth:this.ctx.lineWidth,strokeStyle:this.ctx.strokeStyle,uuid:Dt(),type:this.drawType,path:this.drawingPath,live:!0};this.allShape[t.uuid]=t,(e=this.history)==null||e.record({type:y.ADD,uuid:t.uuid})});u(this,"detectShape",t=>{if(this.isMoving||!this.ctx)return;const e=this.canvas.getBoundingClientRect();for(const n of Object.values(this.allShape)){if(!this.ctx)return;const{path:s,type:a,lineWidth:c,live:o}=n;if(!o)return;this.ctx.save(),a===v.CIRCLE?At(this.canvas,s,{lineWidth:c}):a===v.RECTANGLE?Bt(this.canvas,s,{lineWidth:c}):Ut(this.canvas,s,{lineWidth:c,closePath:a===v.POLYGON});const h=t.clientX-e.x,r=t.clientY-e.y;if(this.ctx.isPointInStroke(M(h),M(r))){this.hoverShape={...n},this.canvas.classList.add("grab"),this.ctx.restore();return}this.ctx.restore()}this.hoverShape=void 0,this.canvas.classList.remove("grab")});u(this,"setBackground",t=>{this.ctx&&(this.ctx.fillStyle=t??"white",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))});u(this,"setDrawType",t=>{this.drawType===v.POLYGON&&this.closePolygon(),this.canvas.classList.remove(v.POLYGON,v.ERASER),(t===v.POLYGON||t===v.ERASER)&&this.canvas.classList.add(t),this.drawType=t});u(this,"setColor",t=>{this.ctx&&(this.color=t,this.ctx.strokeStyle=this.color,this.ctx.fillStyle=this.color)});u(this,"setLineWidth",t=>{this.ctx&&(this.lineWidth=t,this.ctx.lineWidth=this.lineWidth)});u(this,"closePolygon",()=>{this.ctx&&(this.drawingPath.pop(),this.addShape(),this.isPolygonDrawing=!1,this.pathStack={redo:[],undo:[]},this.drawingPath=[],this.refresh())});u(this,"clearBoard",()=>{this.ctx&&(this.allShape={},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height))});u(this,"downloadBoard",()=>{const t=this.canvas.toDataURL();gt(t)});u(this,"redo",()=>{var t;(t=this.history)==null||t.redo()});u(this,"undo",()=>{var t;(t=this.history)==null||t.undo()});u(this,"applyOP",t=>{switch(t.type){case y.ADD:{this.allShape[t.uuid].live=!0;break}case y.DELETE:{this.allShape[t==null?void 0:t.uuid].live=!1;break}case y.UPDATE:if(!t.patch)return;this.allShape[t.uuid]={...this.allShape[t.uuid],...t.patch}}this.refresh()});this.canvas=t,this.drawType=e,this.lineWidth=n,this.color=s,window.drawingPath=this,this.initContext(),this.bindEvent(),this.history=new Gt(this),this.memoCanvas.width=t.width,this.memoCanvas.height=t.height,this.memoCanvas.style.width=`${t.clientWidth}px`,this.memoCanvas.style.height=`${t.clientHeight}px`;const a=this.memoCanvas.getContext("2d");a&&(a.scale(2,2),window.canvasBoard=this)}}let V=[];const Yt=[{type:v.ERASER,name:"橡皮"},{type:v.LINE,name:"铅笔"},{type:v.CIRCLE,name:"圆"},{type:v.RECTANGLE,name:"矩形"},{type:v.POLYGON,name:"钢笔"},{type:v.ARROW,name:"箭头"}],_t=()=>{const i=A(null),t=A(),[e,n]=G(v.POLYGON),[s,a]=G(),[c,o]=G(2),[h,r]=G(!1);K(()=>{const l=i.current;if(!l)return;const p=t.current=new Ht(l,e,c,s);p.onPenPointChange=k=>{V=k,r(k.length>2)}},[]);const g=()=>{var l;return(l=t.current)==null?void 0:l.clearBoard()},d=()=>{var l;return(l=t.current)==null?void 0:l.downloadBoard()},f=l=>{var p;(p=t.current)==null||p.setDrawType(l),n(l),i.current},P=l=>{var p;(p=t.current)==null||p.setColor(l),a(l)},x=l=>{var p;(p=t.current)==null||p.setLineWidth(l),o(l)},w=async()=>{const l=i.current;if(!l)return;const p=l.getContext("2d");if(!p)return;const{left:k,top:R,width:b,height:W}=S(V),N=D(),X=p.getImageData(k*N,R*N,b*N,W*N),B=await q(X,V);B&&gt(B)},L=[E.RED,E.GREEN,E.BLUE,E.YELLOW].map(l=>({name:m("span",{className:"inline-block h-[18px] w-[18px] rounded-full",style:{backgroundColor:l}}),onClick:()=>P(l),selected:s===l})),C=Yt.map(l=>({name:l.name,onClick:()=>f(l.type),selected:e===l.type})),T=[{name:"清除",onClick:g},{name:"下载",onClick:d},...C,...L,{name:"撤销",onClick:()=>{var l;return(l=t.current)==null?void 0:l.undo()}},{name:"重做",onClick:()=>{var l;return(l=t.current)==null?void 0:l.redo()}},{name:m("input",{type:"color",className:"h-5 border-0 bg-transparent",onChange:l=>{const p=l==null?void 0:l.target.value;P(p)}}),onClick:()=>{},selected:![E.RED,E.GREEN,E.BLUE,E.YELLOW].find(l=>s===l)},{name:m(rt,{children:[m("span",{children:"0"}),m("div",{className:"relative flex items-center",children:[m("span",{className:"absolute -top-1.5 text-xs",style:{left:`${c}px`},children:c}),m("input",{type:"range",value:c,className:"h-6 w-[116px] border-0 bg-transparent",onChange:l=>{const p=l==null?void 0:l.target.value;Number(p)<1||x(Number(p))}})]}),m("span",{children:"100"})]}),onClick:()=>{},selected:![E.RED,E.GREEN,E.BLUE,E.YELLOW].find(l=>s===l)},{name:"下载钢笔区域",onClick:w,disabled:!h}];return m("section",{className:"pt-2",children:[m("h1",{className:"mb-4 border-b text-2xl",children:"白板"}),m("div",{className:"mt-2 flex flex-wrap",children:T.map(({onClick:l,name:p,selected:k,disabled:R},b)=>m("button",{onClick:l,disabled:R,className:pt("relative ml-2 mb-2 flex items-center rounded border py-1 px-4 text-sm ",k&&"border-blue-500",R&&"opacity-30"),children:p},b))}),m("canvas",{ref:i,style:{width:"100%",height:600},className:"mt-2 border"})]})},Kt=()=>m(rt,{children:[m(_t,{}),m(Ct,{}),m(Rt,{})]}),$t=Object.freeze(Object.defineProperty({__proto__:null,default:Kt},Symbol.toStringTag,{value:"Module"}));export{yt as C,Y as _,_ as a,M as b,S as c,I as d,gt as e,$t as f,D as g,q as i,Dt as u};
