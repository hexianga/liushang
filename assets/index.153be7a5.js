var J=Object.defineProperty;var W=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var j=(h,e,n)=>e in h?J(h,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):h[e]=n,k=(h,e)=>{for(var n in e||(e={}))_.call(e,n)&&j(h,n,e[n]);if(W)for(var n of W(e))q.call(e,n)&&j(h,n,e[n]);return h};import{r as S,j as f}from"./index.884a7d06.js";import{p as Q,d as M,a as G,b as D,c as Y,e as V,u as Z,f as I,g as X,h as N,i as H,j as tt}from"./draw-line.0806594e.js";import{c as et}from"./index.c07bb25e.js";import{_ as U}from"./index.28d32a59.js";import"./hasIn.79d63027.js";import"./_arrayPush.ff56b0a1.js";import"./_commonjsHelpers.294d03c4.js";import"./index.563d4b32.js";var d=(h=>(h.POLYGON="polygon",h.RECTANGLE="rectangle",h.CIRCLE="circle",h.LINE="line",h.ARROW="arrow",h.ERASER="eraser",h))(d||{}),w=(h=>(h.GREEN="green",h.BLUE="blue",h.YELLOW="yellow",h.RED="red",h))(w||{}),E=(h=>(h.ADD="add",h.UPDATE="update",h.DELETE="delete",h))(E||{});const T=(h,e)=>{const n=h.getContext("2d");!n||(n.save(),n.beginPath(),n.globalCompositeOperation="destination-out",n.arc(e.x,e.y,5,0,2*Math.PI),n.clip(),n.clearRect(0,0,h.width,h.height),n.restore())},F=(h,e,n)=>{const o=h.getContext("2d");if(!o)return;const{x:m,y:p}=e,{x:t,y:s}=n,i=5*Math.sin(Math.atan((s-p)/(t-m))),a=5*Math.cos(Math.atan((s-p)/(t-m))),c=m+i,u=p-a,g=m-i,v=p+a,l=t+i,P=s-a,y=t-i,L=s+a;T(h,n),o.save(),o.beginPath(),o.globalCompositeOperation="destination-out",o.moveTo(c,u),o.lineTo(l,P),o.lineTo(y,L),o.lineTo(g,v),o.closePath(),o.clip(),o.clearRect(0,0,h.width,h.height),o.restore()},st=(h,e,n)=>{var l;const o=h.getContext("2d");if(!o)return;const m=e[0],p=e[1],{x:t,y:s}=m,{x:i,y:a}=p,c=Math.abs(i-t),u=Math.abs(a-s),g=Math.min(i,t)+c/2,v=Math.min(a,s)+u/2;o.lineWidth=Math.max(8,(l=n==null?void 0:n.lineWidth)!=null?l:0),o.beginPath(),o.ellipse(g,v,c/2,u/2,0,0,2*Math.PI),o.closePath()},it=(h,e,n)=>{var l;const o=h.getContext("2d");if(!o)return;const m=e[0],p=e[1],{x:t,y:s}=m,{x:i,y:a}=p,c=Math.abs(i-t),u=Math.abs(a-s),g=Math.min(i,t),v=Math.min(a,s);o.lineWidth=Math.max(8,(l=n==null?void 0:n.lineWidth)!=null?l:0),o.beginPath(),o.rect(g,v,c,u)},nt=(h,e,n)=>{var m;const o=h.getContext("2d");!o||(o.lineWidth=Math.max(8,(m=n==null?void 0:n.lineWidth)!=null?m:0),o.beginPath(),e.forEach((p,t)=>{t===0?o.moveTo(p.x,p.y):o.lineTo(p.x,p.y)}),n.closePath&&o.closePath())};class at{constructor(e){this.canvasBoard=e,this.delay=1e3,this.maxStack=100,this.userOnly=!1,this.lastRecorded=0,this.redoStack=[],this.undoStack=[]}record(e,n){const o=this.inverse(e,n);o&&this.undoStack.push(o)}inverse(e,n){switch(e.type){case E.ADD:return{type:E.DELETE,uuid:e.uuid};case E.DELETE:return{type:E.ADD,uuid:e.uuid};case E.UPDATE:{if(!e.patch)return;const o=Q(n,Object.keys(e.patch));return{type:E.UPDATE,uuid:e.uuid,patch:o}}}}redo(){if(this.redoStack.length===0)return;const e=this.redoStack.pop();if(!e)return;const n=this.inverse(e,this.canvasBoard.allShape[e==null?void 0:e.uuid]);n&&(this.undoStack.push(n),this.undoStack.length>this.maxStack&&this.undoStack.shift()),this.canvasBoard.applyOP(e)}undo(){var o;if(this.undoStack.length===0)return;const e=this.undoStack.pop();if(!e)return;const n=this.inverse(e,this.canvasBoard.allShape[(o=e==null?void 0:e.uuid)!=null?o:""]);n&&(this.redoStack.push(n),this.redoStack.length>this.maxStack&&this.redoStack.shift()),this.canvasBoard.applyOP(e)}clear(){this.redoStack=[],this.undoStack=[]}}class ht{constructor(e,n,o=2,m="#000"){this.canvas=e,this.drawType=n,this.lineWidth=o,this.color=m,this.allShape={},this.drawingPath=[],this.isMoving=!1,this.isPolygonDrawing=!1,this.oldShape=[],this.memoCanvas=document.createElement("canvas"),this.initContext=()=>{const t=N();if(this.canvas.width=Math.floor(this.canvas.clientWidth*t),this.canvas.height=Math.floor(this.canvas.clientHeight*t),this.ctx=this.canvas.getContext("2d"),!this.ctx)return;this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.lineWidth,this.ctx.scale(t,t),this.setBackground();const s=a=>{a.forEach(c=>{c.target===this.canvas&&this.updateCtx()})};new ResizeObserver(s).observe(this.canvas)},this.updateCtx=()=>{const t=N();this.canvas.width=Math.floor(this.canvas.clientWidth*t),this.canvas.height=Math.floor(this.canvas.clientHeight*t),this.ctx=this.canvas.getContext("2d"),this.ctx&&(this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.color,this.ctx.lineWidth=this.lineWidth,this.ctx.scale(t,t),this.refresh())},this.bindEvent=()=>{const t=i=>{if(this.hoverShape){this.moveShape(i);return}if(this.drawType===d.POLYGON){this.drawPolygon(i);return}if(this.drawType===d.RECTANGLE){this.drawRectangle(i);return}if(this.drawType===d.CIRCLE){this.drawCircle(i);return}if(this.drawType===d.ARROW){this.dragArrow(i);return}(this.drawType===d.LINE||this.drawType===d.ERASER)&&this.drawLineAndEraser(i)},s=i=>{var a,c;U("esc")(i)?this.drawType===d.POLYGON&&this.closePolygon():U("Backspace")(i)&&this.activeShape&&(this.allShape[(a=this.activeShape)==null?void 0:a.uuid].live=!1,(c=this.history)==null||c.record({type:E.DELETE,uuid:this.activeShape.uuid}),this.refresh())};window.addEventListener("keydown",s),this.canvas.addEventListener("mousedown",t),this.canvas.addEventListener("mousemove",this.detectShape)},this.refresh=()=>{!this.ctx||(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),Object.values(this.allShape).forEach(({live:t,type:s,strokeStyle:i,path:a,lineWidth:c})=>{!this.ctx||!t||(s===d.POLYGON?M(this.ctx,a,{lineWidth:c,strokeStyle:i,closePath:!0}):s===d.RECTANGLE?G(this.canvas,a[0],a[1],{lineWidth:c,strokeStyle:i}):s===d.LINE?M(this.ctx,a,{lineWidth:c,strokeStyle:i,lineCap:"round",lineJoin:"round"}):s===d.CIRCLE?D(this.canvas,a[0],a[1],{lineWidth:c,strokeStyle:i}):s===d.ERASER?a.forEach((u,g)=>{g!==a.length-1&&(g===0?T(this.canvas,u):F(this.canvas,u,a[g+1]))}):s===d.ARROW&&Y(this.canvas,a[0],a[1],{lineWidth:c,strokeStyle:i}))}))},this.moveShape=t=>{this.isMoving=!0;const s=this.getPoint(t),i=c=>{var P;if(!this.hoverShape)return;const u=this.getPoint(c),g=u.x-s.x,v=u.y-s.y,l=this.hoverShape.path.map(y=>({x:y.x+g,y:y.y+v}));this.allShape[(P=this.hoverShape)==null?void 0:P.uuid].path=l,this.refresh()},a=()=>{var c,u;if(document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",a),this.hoverShape){if(!this.ctx)return;const g=this.allShape[(c=this.hoverShape)==null?void 0:c.uuid];if(!g)return;const{path:v}=g;(u=this.history)==null||u.record({type:E.UPDATE,uuid:this.hoverShape.uuid,patch:{path:v}},this.hoverShape);const l=H(v);this.ctx.save(),this.ctx.lineWidth=2,this.ctx.strokeStyle="rgba(0,255,0,0.5)",this.ctx.strokeRect(l.left,l.top,l.width,l.height),this.ctx.restore(),this.activeShape=g}this.isMoving=!1,this.hoverShape=void 0};document.addEventListener("mousemove",i),document.addEventListener("mouseup",a)},this.getPoint=t=>{const s=this.canvas.getBoundingClientRect();return{x:t.clientX-s.x,y:t.clientY-s.y}},this.drawLineAndEraser=t=>{let s=this.getPoint(t);this.drawingPath.push(s),this.drawType===d.ERASER&&T(this.canvas,s);const i=c=>{if(!this.ctx)return;const u=this.getPoint(c);this.drawingPath.push(u),this.drawType===d.LINE?M(this.ctx,[s,u],{lineCap:"round",lineJoin:"round"}):F(this.canvas,s,u),s=u},a=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",a),this.ctx&&(this.addShape(),this.drawingPath=[])};document.addEventListener("mousemove",i),document.addEventListener("mouseup",a)},this.drawPolygon=t=>{var a;if(!this.ctx)return;this.isPolygonDrawing||(this.isPolygonDrawing=!0);const s=this.getPoint(t);V(this.canvas,s),this.drawingPath.push(s),(a=this.onPenPointChange)==null||a.call(this,this.drawingPath);const i=c=>{if(!this.isPolygonDrawing){document.removeEventListener("mousemove",i);return}!this.ctx||(this.drawingPath.length>1&&this.drawingPath.pop(),this.drawingPath.push(this.getPoint(c)),this.refresh(),M(this.ctx,this.drawingPath,{lineCap:"round",joinShape:"round"}))};document.addEventListener("mousemove",i)},this.drawCircle=t=>{let s=!1;this.drawingPath.push(this.getPoint(t));const i=v=>{if(!this.ctx)return;this.drawingPath.length>1&&this.drawingPath.pop();const l=this.getPoint(v);this.drawingPath.push(l),this.refresh();const P=s?a(this.drawingPath[0],l):l;D(this.canvas,this.drawingPath[0],P)},a=(v,l)=>{const P=l.x-v.x,y=l.y-v.y,L=Math.max(Math.abs(P),Math.abs(y));return{x:P>0?v.x+L:v.x-L,y:y>0?v.y+L:v.y-L}},c=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",c),document.removeEventListener("keydown",u),document.removeEventListener("keyup",g),this.ctx&&(this.drawingPath.length>1&&(s&&(this.drawingPath[1]=a(this.drawingPath[0],this.drawingPath[1])),this.addShape()),this.drawingPath=[])},u=v=>{if(v.shiftKey){s=!0,this.refresh();const l=a(this.drawingPath[0],this.drawingPath[1]);D(this.canvas,this.drawingPath[0],l)}},g=()=>{s=!1,this.refresh(),D(this.canvas,this.drawingPath[0],this.drawingPath[1])};document.addEventListener("mousemove",i),document.addEventListener("mouseup",c),document.addEventListener("keydown",u),document.addEventListener("keyup",g)},this.drawRectangle=t=>{this.drawingPath.push(this.getPoint(t));const s=a=>{!this.ctx||(this.drawingPath.length>1&&this.drawingPath.pop(),this.drawingPath.push(this.getPoint(a)),this.refresh(),G(this.canvas,this.drawingPath[0],this.drawingPath[1]))},i=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i),this.ctx&&(this.drawingPath.length>1&&this.addShape(),this.drawingPath=[])};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},this.dragArrow=t=>{if(!this.ctx)return;this.drawingPath.push(this.getPoint(t));const s=a=>{!this.ctx||(this.drawingPath.length>1&&this.drawingPath.pop(),this.drawingPath.push(this.getPoint(a)),this.refresh(),console.log(this.ctx.lineWidth),Y(this.canvas,this.drawingPath[0],this.drawingPath[1]))},i=()=>{!this.ctx||(this.drawingPath.length>1&&this.addShape(),this.drawingPath=[],document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",i))};document.addEventListener("mousemove",s),document.addEventListener("mouseup",i)},this.addShape=()=>{var s;if(!this.ctx)return;const t={lineWidth:this.ctx.lineWidth,strokeStyle:this.ctx.strokeStyle,uuid:Z(),type:this.drawType,path:this.drawingPath,live:!0};this.allShape[t.uuid]=t,(s=this.history)==null||s.record({type:E.ADD,uuid:t.uuid})},this.detectShape=t=>{if(this.isMoving||!this.ctx)return;const s=this.canvas.getBoundingClientRect();for(const i of Object.values(this.allShape)){if(!this.ctx)return;const{path:a,type:c,lineWidth:u,live:g}=i;if(!g)return;this.ctx.save(),c===d.CIRCLE?st(this.canvas,a,{lineWidth:u}):c===d.RECTANGLE?it(this.canvas,a,{lineWidth:u}):nt(this.canvas,a,{lineWidth:u,closePath:c===d.POLYGON});const v=t.clientX-s.x,l=t.clientY-s.y;if(this.ctx.isPointInStroke(I(v),I(l))){this.hoverShape=k({},i),this.canvas.classList.add("grab"),this.ctx.restore();return}this.ctx.restore()}this.hoverShape=void 0,this.canvas.classList.remove("grab")},this.setBackground=t=>{!this.ctx||(this.ctx.fillStyle=t!=null?t:"white",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))},this.setDrawType=t=>{this.drawType===d.POLYGON&&this.closePolygon(),this.canvas.classList.remove(d.POLYGON,d.ERASER),(t===d.POLYGON||t===d.ERASER)&&this.canvas.classList.add(t),this.drawType=t},this.setColor=t=>{!this.ctx||(this.color=t,this.ctx.strokeStyle=this.color,this.ctx.fillStyle=this.color)},this.setLineWidth=t=>{!this.ctx||(this.lineWidth=t,this.ctx.lineWidth=this.lineWidth)},this.closePolygon=()=>{!this.ctx||(this.drawingPath.pop(),this.addShape(),this.isPolygonDrawing=!1,this.drawingPath=[],this.refresh())},this.clearBoard=()=>{!this.ctx||(this.allShape={},this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height))},this.downloadBoard=()=>{const t=this.canvas.toDataURL();X(t)},this.redo=()=>{var t;(t=this.history)==null||t.redo()},this.undo=()=>{var t;(t=this.history)==null||t.undo()},this.applyOP=t=>{switch(t.type){case E.ADD:{this.allShape[t.uuid].live=!0;break}case E.DELETE:{this.allShape[t==null?void 0:t.uuid].live=!1;break}case E.UPDATE:if(!t.patch)return;this.allShape[t.uuid]=k(k({},this.allShape[t.uuid]),t.patch)}this.refresh()},this.initContext(),this.bindEvent(),this.history=new at(this),this.memoCanvas.width=e.width,this.memoCanvas.height=e.height,this.memoCanvas.style.width=`${e.clientWidth}px`,this.memoCanvas.style.height=`${e.clientHeight}px`;const p=this.memoCanvas.getContext("2d");!p||(p.scale(2,2),window.canvasBoard=this)}}let O=[];const rt=[{type:d.ERASER,name:"\u6A61\u76AE"},{type:d.LINE,name:"\u94C5\u7B14"},{type:d.CIRCLE,name:"\u5706"},{type:d.RECTANGLE,name:"\u77E9\u5F62"},{type:d.POLYGON,name:"\u94A2\u7B14"},{type:d.ARROW,name:"\u7BAD\u5934"}],ot=()=>{const h=S.exports.useRef(null),e=S.exports.useRef(),[n,o]=S.exports.useState(d.CIRCLE),[m,p]=S.exports.useState(),[t,s]=S.exports.useState(2),[i,a]=S.exports.useState(!1);S.exports.useEffect(()=>{const r=h.current;if(!r)return;const x=e.current=new ht(r,n,t,m);x.onPenPointChange=C=>{O=C,a(C.length>2)}},[]);const c=()=>{var r;return(r=e.current)==null?void 0:r.clearBoard()},u=()=>{var r;return(r=e.current)==null?void 0:r.downloadBoard()},g=r=>{var x;(x=e.current)==null||x.setDrawType(r),o(r),h.current},v=r=>{var x;(x=e.current)==null||x.setColor(r),p(r)},l=r=>{var x;(x=e.current)==null||x.setLineWidth(r),s(r)},P=async()=>{const r=h.current;if(!r)return;const x=r.getContext("2d");if(!x)return;const{left:C,top:R,width:A,height:z}=H(O),b=N(),$=x.getImageData(C*b,R*b,A*b,z*b),B=await tt($,O);B&&X(B)},y=[w.RED,w.GREEN,w.BLUE,w.YELLOW].map(r=>({name:f.exports.jsx("span",{className:"inline-block h-[18px] w-[18px] rounded-full",style:{backgroundColor:r}}),onClick:()=>v(r),selected:m===r})),L=rt.map(r=>({name:r.name,onClick:()=>g(r.type),selected:n===r.type})),K=[{name:"\u6E05\u9664",onClick:c},{name:"\u4E0B\u8F7D",onClick:u},...L,...y,{name:"\u64A4\u9500",onClick:()=>{var r;return(r=e.current)==null?void 0:r.undo()}},{name:"\u91CD\u505A",onClick:()=>{var r;return(r=e.current)==null?void 0:r.redo()}},{name:f.exports.jsx("input",{type:"color",className:"h-5 border-0 bg-transparent",onChange:r=>{const x=r==null?void 0:r.target.value;v(x)}}),onClick:()=>{},selected:![w.RED,w.GREEN,w.BLUE,w.YELLOW].find(r=>m===r)},{name:f.exports.jsxs(f.exports.Fragment,{children:[f.exports.jsx("span",{children:"0"}),f.exports.jsxs("div",{className:"relative flex items-center",children:[f.exports.jsx("span",{className:"absolute -top-1.5 text-xs",style:{left:`${t}px`},children:t}),f.exports.jsx("input",{type:"range",value:t,className:"h-6 w-[116px] border-0 bg-transparent",onChange:r=>{const x=r==null?void 0:r.target.value;Number(x)<1||l(Number(x))}})]}),f.exports.jsx("span",{children:"100"})]}),onClick:()=>{},selected:![w.RED,w.GREEN,w.BLUE,w.YELLOW].find(r=>m===r)},{name:"\u4E0B\u8F7D\u94A2\u7B14\u533A\u57DF",onClick:P,disabled:!i}];return f.exports.jsxs("section",{className:"pt-2",children:[f.exports.jsx("h1",{className:"mb-4 border-b text-2xl",children:"\u767D\u677F"}),f.exports.jsx("div",{className:"mt-2 flex flex-wrap",children:K.map(({onClick:r,name:x,selected:C,disabled:R},A)=>f.exports.jsx("button",{onClick:r,disabled:R,className:et("relative ml-2 mb-2 flex items-center rounded border py-1 px-4 text-sm ",C&&"border-blue-500",R&&"opacity-30"),children:x},A))}),f.exports.jsx("canvas",{ref:h,style:{width:"100%",height:600},className:"mt-2 border"})]})},ft=()=>f.exports.jsx(f.exports.Fragment,{children:f.exports.jsx(ot,{})});export{ft as default};
